"""{{.ServiceName}} service BUILD configuration"""

load("@aspect_rules_js//js:defs.bzl", "js_library")
load("@aspect_rules_ts//ts:defs.bzl", "ts_project")
load("@rules_oci//oci:defs.bzl", "oci_image", "oci_tarball")
load("@rules_pkg//pkg:tar.bzl", "pkg_tar")

package(default_visibility = ["//visibility:public"])

# NPM dependencies
js_library(
    name = "node_modules",
    srcs = ["//:node_modules"],
)

# TypeScript compilation
ts_project(
    name = "compile",
    srcs = glob([
        "src/**/*.ts",
        "test/**/*.ts",
    ]),
    declaration = True,
    source_map = True,
    tsconfig = "tsconfig.json",
    deps = [":node_modules"],
)

# Package compiled JavaScript and assets
pkg_tar(
    name = "app_layer",
    srcs = [
        ":compile",
        "package.json",
    ],
    package_dir = "/app",
    strip_prefix = ".",
)

# NestJS service OCI image using Bazel builder
oci_image(
    name = "image",
    base = "@distroless_nodejs",
    entrypoint = ["node", "/app/dist/main.js"],
    exposed_ports = ["3000"],
    tars = [":app_layer"],
    env = {
        "NODE_ENV": "production",
        "PORT": "3000",
    },
)

# Export as tarball for Skaffold
oci_tarball(
    name = "image_tarball",
    image = ":image",
    repo_tags = ["{{.ServiceName}}:latest"],
)
)

# Extract the actual tarball file for Skaffold Bazel builder
filegroup(
    name = "image_tarball.tar",
    srcs = [":image.tar"],
    output_group = "tarball",
    visibility = ["//visibility:public"],
)
