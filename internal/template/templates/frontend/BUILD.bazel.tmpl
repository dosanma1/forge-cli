# BUILD.bazel for {{.AppName}} frontend application
# Uses Angular CLI (ng build) via Bazel genrule
# This allows Bazel to track dependencies while using the official Angular build system

# Track all source files for dependency detection
filegroup(
    name = "sources",
    srcs = glob([
        "src/**/*",
        "public/**/*",
        "*.json",
        "*.ts",
    ]),
    visibility = ["//visibility:public"],
)

# Production build using Angular CLI
genrule(
    name = "ng_build_prod",
    srcs = [
        ":sources",
        "//frontend:angular_json",
        "//frontend:package_json",
        "//frontend:node_modules",
    ],
    outs = ["dist"],
    cmd = """
        # Setup environment
        export HOME=$$PWD/.home
        export NODE_OPTIONS="--max-old-space-size=4096"
        mkdir -p $$HOME
        
        # Create working directory structure
        WORK_DIR=$$PWD/build_tmp
        mkdir -p $$WORK_DIR/frontend/projects/{{.AppName}}
        
        # Copy Angular workspace files
        cp $(location //frontend:angular_json) $$WORK_DIR/frontend/angular.json
        cp $(location //frontend:package_json) $$WORK_DIR/frontend/package.json
        
        # Copy source files
        for src in $(SRCS); do
            if [[ $$src != *"angular.json" ]] && [[ $$src != *"package.json" ]] && [[ $$src != *"node_modules"* ]]; then
                cp -r $$src $$WORK_DIR/frontend/projects/{{.AppName}}/
            fi
        done
        
        # Link node_modules
        ln -sf $$(realpath $(location //frontend:node_modules)) $$WORK_DIR/frontend/node_modules
        
        # Run Angular build
        cd $$WORK_DIR/frontend
        npx ng build {{.AppName}} --configuration=production --output-path=../../dist
        
        # Copy output to Bazel location
        cp -r $$PWD/../../dist/* $@/
    """,
    visibility = ["//visibility:public"],
    tags = ["no-cache"],
)

# Development build using Angular CLI
genrule(
    name = "ng_build_dev",
    srcs = [
        ":sources",
        "//frontend:angular_json",
        "//frontend:package_json",
        "//frontend:node_modules",
    ],
    outs = ["dist_dev"],
    cmd = """
        export HOME=$$PWD/.home
        export NODE_OPTIONS="--max-old-space-size=4096"
        mkdir -p $$HOME
        
        WORK_DIR=$$PWD/build_tmp
        mkdir -p $$WORK_DIR/frontend/projects/{{.AppName}}
        
        cp $(location //frontend:angular_json) $$WORK_DIR/frontend/angular.json
        cp $(location //frontend:package_json) $$WORK_DIR/frontend/package.json
        
        for src in $(SRCS); do
            if [[ $$src != *"angular.json" ]] && [[ $$src != *"package.json" ]] && [[ $$src != *"node_modules"* ]]; then
                cp -r $$src $$WORK_DIR/frontend/projects/{{.AppName}}/
            fi
        done
        
        ln -sf $$(realpath $(location //frontend:node_modules)) $$WORK_DIR/frontend/node_modules
        
        cd $$WORK_DIR/frontend
        npx ng build {{.AppName}} --configuration=development --output-path=../../dist_dev
        
        cp -r $$PWD/../../dist_dev/* $@/
    """,
    visibility = ["//visibility:public"],
    tags = ["no-cache"],
)

# Default build target (production)
alias(
    name = "build",
    actual = ":ng_build_prod",
    visibility = ["//visibility:public"],
)
