# BUILD.bazel for {{.AppName}} frontend application
# Self-contained app with its own config files and node_modules
# Uses Angular CLI (ng build) via Bazel genrule

# Export config files for Bazel to track
exports_files([
    "angular.json",
    "package.json",
    "tsconfig.json",
    "tsconfig.app.json",
    "tsconfig.spec.json",
])

# Track all source files for dependency detection
filegroup(
    name = "sources",
    srcs = glob(
        [
            "src/**/*",
            "public/**/*",
        ],
        allow_empty = True,
    ),
    visibility = ["//visibility:public"],
)

# Track node_modules (exclude unnecessary files to speed up Bazel)
filegroup(
    name = "node_modules",
    srcs = glob(
        ["node_modules/**/*"],
        exclude = [
            "node_modules/**/*.md",
            "node_modules/**/*.markdown",
            "node_modules/**/test/**",
            "node_modules/**/tests/**",
            "node_modules/**/*.map",
            "node_modules/**/.cache/**",
        ],
    ),
    visibility = ["//visibility:public"],
)

# Angular build using Angular CLI with environment variable
# Use --define ENV=production or --define ENV=development to control the build
genrule(
    name = "ng_build",
    srcs = [
        ":sources",
        "angular.json",
        "package.json",
        "tsconfig.json",
        "tsconfig.app.json",
        "tsconfig.spec.json",
        ":node_modules",
    ],
    outs = ["dist.tar.gz"],
    output_to_bindir = 1,
    cmd = """
        # Setup environment
        export HOME=$$PWD/.home
        export NODE_OPTIONS="--max-old-space-size=4096"
        mkdir -p $$HOME
        
        # Store the execroot directory for tar output
        EXECROOT=$$PWD
        
        # Get environment from Bazel variable (defaults to production)
        ENV=$${ENV:-production}
        
        # Create working directory
        WORK_DIR=$$PWD/build_tmp
        mkdir -p $$WORK_DIR
        
        # Copy config files to working directory
        cp $(location angular.json) $$WORK_DIR/angular.json
        cp $(location package.json) $$WORK_DIR/package.json
        cp $(location tsconfig.json) $$WORK_DIR/tsconfig.json
        cp $(location tsconfig.app.json) $$WORK_DIR/tsconfig.app.json
        cp $(location tsconfig.spec.json) $$WORK_DIR/tsconfig.spec.json
        
        # Copy source files to working directory
        mkdir -p $$WORK_DIR/src
        for src in $(locations :sources); do
            if [[ $$src == */src/* ]]; then
                rel_path=$${src#*src/}
                target_dir=$$(dirname "$$WORK_DIR/src/$$rel_path")
                mkdir -p "$$target_dir"
                cp "$$src" "$$WORK_DIR/src/$$rel_path"
            elif [[ $$src == */public/* ]]; then
                rel_path=$${src#*public/}
                target_dir=$$(dirname "$$WORK_DIR/public/$$rel_path")
                mkdir -p "$$target_dir"
                cp "$$src" "$$WORK_DIR/public/$$rel_path"
            fi
        done
        
        # Link node_modules to working directory
        # Find first node_modules file to determine the directory
        NODE_MODULES_FILE=$$(echo "$(locations :node_modules)" | awk '{print $$1}')
        NODE_MODULES_DIR=$$(dirname $$(dirname $$NODE_MODULES_FILE))
        ln -sf $$(realpath $$NODE_MODULES_DIR) $$WORK_DIR/node_modules
        
        # Run Angular build with environment-specific configuration
        cd $$WORK_DIR
        npx ng build --configuration=$$ENV --output-path=dist
        
        # Create tar from output using absolute path from EXECROOT
        cd dist
        tar -czf $$EXECROOT/$@ .
    """,
    visibility = ["//visibility:public"],
    tags = ["no-cache"],
)

# Default build target
alias(
    name = "build",
    actual = ":ng_build",
    visibility = ["//visibility:public"],
)
