"""Server binary BUILD configuration"""

load("@rules_go//go:def.bzl", "go_binary", "go_library")
load("@rules_oci//oci:defs.bzl", "oci_image")
load("@rules_pkg//pkg:tar.bzl", "pkg_tar")

go_library(
    name = "server_lib",
    srcs = ["main.go"],
    importpath = "{{.ModulePath}}/cmd/server",
    visibility = ["//visibility:private"],
)

go_binary(
    name = "server",
    embed = [":server_lib"],
    visibility = ["//visibility:public"],
)

# Package the binary for the container
pkg_tar(
    name = "server_tar",
    srcs = [":server"],
    package_dir = "/app",
)

# Build OCI image using distroless base
oci_image(
    name = "image",
    base = "@distroless_base",
    entrypoint = ["/app/server"],
    tars = [":server_tar"],
    exposed_ports = ["8080/tcp"],
    env = {
        "PORT": "8080",
    },
    visibility = ["//visibility:public"],
)

# Export image as tar for Skaffold
pkg_tar(
    name = "image.tar",
    srcs = [":image"],
    extension = "tar",
    visibility = ["//visibility:public"],
)
