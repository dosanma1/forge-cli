apiVersion: skaffold/v4beta11
kind: Config
metadata:
  name: {{.ServiceName}}

# Bazel Integration: Skaffold uses Bazel to build images with Docker-format tarballs
# for compatibility. Bazel automatically detects changes and only rebuilds affected
# services (incremental builds). Multi-platform builds and caching for faster CI/CD.

build:
  artifacts:
    - image: {{.ServiceName}}
      bazel:
        target: //backend/services/{{.ServiceName}}/cmd/server:image_tarball.tar
        args:
          - --platforms=@rules_go//go/toolchain:linux_amd64
  tagPolicy:
    gitCommit:
      variant: AbbrevCommitSha

# Default deployment using Helm
deploy:
  helm:
    releases:
      - name: {{.ServiceName}}
        chartPath: ../../../infra/helm/service
        valuesFiles:
          - ./deploy/helm/values.yaml
        namespace: {{.ProjectName}}
        createNamespace: true
        setValueTemplates:
          image.repository: "{{`{{.IMAGE_REPO_`}}{{.ServiceName}}{{`}}`}}"
          image.tag: "{{`{{.IMAGE_TAG_`}}{{.ServiceName}}{{`}}@{{.IMAGE_DIGEST_`}}{{.ServiceName}}{{`}}`}}"

profiles:
  # Local development profile for Kind cluster
  - name: local
    build:
      artifacts:
        - image: {{.ServiceName}}
          bazel:
            target: //backend/services/{{.ServiceName}}/cmd/server:image_tarball.tar
      local:
        push: false
    deploy:
      helm:
        releases:
          - name: {{.ServiceName}}
            chartPath: ../../../infra/helm/service
            valuesFiles:
              - ./deploy/helm/values.yaml
              - ./deploy/helm/values-dev.yaml
            namespace: {{.ProjectName}}
            createNamespace: true
            setValues:
              image.pullPolicy: IfNotPresent
            setValueTemplates:
              image.repository: "{{`{{.IMAGE_REPO_`}}{{.ServiceName}}{{`}}`}}"
              image.tag: "{{`{{.IMAGE_TAG_`}}{{.ServiceName}}{{`}}`}}"

  # Dev environment with Google Cloud Build
  - name: dev
    build:
      artifacts:
        - image: {{.ServiceName}}
          bazel:
            target: //backend/services/{{.ServiceName}}/cmd/server:image_tarball.tar
            args:
              - --platforms=@rules_go//go/toolchain:linux_amd64
      googleCloudBuild:
        projectId: {{.GCPProjectID}}
    deploy:
      helm:
        releases:
          - name: {{.ServiceName}}-dev
            chartPath: ../../../infra/helm/service
            valuesFiles:
              - ./deploy/helm/values.yaml
              - ./deploy/helm/values-dev.yaml
            namespace: dev
            createNamespace: true
            setValueTemplates:
              image.repository: "{{`{{.IMAGE_REPO_`}}{{.ServiceName}}{{`}}`}}"
              image.tag: "{{`{{.IMAGE_TAG_`}}{{.ServiceName}}{{`}}@{{.IMAGE_DIGEST_`}}{{.ServiceName}}{{`}}`}}"

  # Production environment with strict builds
  - name: prod
    build:
      artifacts:
        - image: {{.ServiceName}}
          bazel:
            target: //backend/services/{{.ServiceName}}/cmd/server:image_tarball.tar
            args:
              - --platforms=@rules_go//go/toolchain:linux_amd64
              - --config=prod
      googleCloudBuild:
        projectId: {{.GCPProjectID}}
    deploy:
      helm:
        releases:
          - name: {{.ServiceName}}-prod
            chartPath: ../../../infra/helm/service
            valuesFiles:
              - ./deploy/helm/values.yaml
              - ./deploy/helm/values-prod.yaml
            namespace: prod
            createNamespace: true
            setValueTemplates:
              image.repository: "{{`{{.IMAGE_REPO_`}}{{.ServiceName}}{{`}}`}}"
              image.tag: "{{`{{.IMAGE_TAG_`}}{{.ServiceName}}{{`}}@{{.IMAGE_DIGEST_`}}{{.ServiceName}}{{`}}`}}"

  # Cloud Run deployment profile
  - name: cloudrun
    build:
      artifacts:
        - image: {{.ServiceName}}
          bazel:
            target: //backend/services/{{.ServiceName}}/cmd/server:image_tarball.tar
            args:
              - --platforms=@rules_go//go/toolchain:linux_amd64
      googleCloudBuild:
        projectId: {{.GCPProjectID}}
    deploy:
      cloudrun:
        projectid: {{.GCPProjectID}}
        region: us-central1
